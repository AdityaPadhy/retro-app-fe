<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-datatable-api/paper-datatable-api-column.html">
<link rel="import" href="../../bower_components/paper-datatable-api/paper-datatable-api.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-alert-dialog/paper-alert-dialog-icon-header.html">
<link rel="import" href="../../bower_components/paper-alert-dialog/paper-alert-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-error.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-container.html">

<dom-module id="retro-team">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
        font-family: sans-serif;
      }

      paper-input iron-icon {
        color: var(--paper-grey-600);
      }

      paper-button {
        margin-top: 1em;
        font-family: 'Roboto', 'Noto', sans-serif;
        font-weight: normal;
        font-size: 14px;
        -webkit-font-smoothing: antialiased;
      }

      paper-datatable-api {
        --paper-datatable-api-checked-checkbox-color: black;
      }

      paper-dialog {
        min-width: 70px;
        min-height: 60px;
        display: block;
        font-family: sans-serif;
        background: white;
        color: black;
        padding: 24px;
        box-shadow: rgba(0, 0, 0, 0.24) -2px 5px 12px 0px, rgba(0, 0, 0, 0.12) 0px 0px 12px 0px;
      }

      paper-dialog paper-dialog-scrollable {
        --paper-dialog-scrollable: {
          box-sizing: border-box;
          width: 500px;
          height: 400px;
        }
      }
    </style>

    <h2>The Team<h2>

        <paper-alert-dialog id="addConfirm" confirm-button="Got it">
            <paper-alert-dialog-icon-header icon="icons:done">Well done!</paper-alert-dialog-icon-header>
            Excellent, User Added
          </paper-alert-dialog>

          <paper-alert-dialog id="allfailed" confirm-button="Got it">
              <paper-alert-dialog-icon-header style="color:red" icon="icons:error">Failed!</paper-alert-dialog-icon-header>
              Failed. Server Error
            </paper-alert-dialog>
          

        <iron-ajax id="getUser" auto url="http://localhost:8888/user/users" handle-as="json" last-response="{{data}}"></iron-ajax>

        <iron-ajax id="addUser" method="PUT" body="{{putBody}}" handle-as="json" content-type="application/json" on-response="addSuccess" last-response="{{data}}"
          on-error="userAddError" last-error="{{userError}}" url="http://localhost:8888/user/add">
        </iron-ajax>

        <iron-ajax id="sortUser" method="POST" body="{{postBody}}" handle-as="json" content-type="application/json" last-response="{{data}}"
          on-error="userAddError" last-error="{{userError}}" url="http://localhost:8888/user/sort">
        </iron-ajax>

        <iron-ajax id="deleteUser" method="POST" body="{{deleteBody}}" handle-as="json" content-type="application/json" on-response="deleteSuccess"
          on-error="userAddError" last-error="{{userError}}" url="http://localhost:8888/user/delete">
        </iron-ajax>

        <paper-datatable-api selectable data="{{data}}" on-sort="_handleSort" selected-rows={{selectedRows}} on-selection-changed="_handleSelectionChanged"
          selectable-data-key="id">
          <paper-datatable-api-column draggable-column header="Name" type="String" property="name" sortable>
            <template>
              <span>{{value}}</span>
            </template>
          </paper-datatable-api-column>
          <paper-datatable-api-column header="Email" type="String" property="email">
            <template>
              <span>{{value}}</span>
            </template>
          </paper-datatable-api-column>
          <paper-datatable-api-column header="Role" type="String" property="role">
            <template>
              <span>{{value}}</span>
            </template>
          </paper-datatable-api-column>
        </paper-datatable-api>

        <center>
          <paper-button raised class="green" on-tap="addNewMember">Add a new member</paper-button>
          <paper-button raised class="red" on-tap="deleteUsers">Remove Selected Member</paper-button>
        </center>

        <paper-dialog id="dialog" backdrop autoclosedisabled>
          <h2>Join Team</h2>
          <paper-dialog-scrollable>
            <paper-input id="uname" label="User Name" value="{{putBody.name}}" validate="^[A-Za-z0-9]*$" error-message="Are you Nuts!!!"
              required>
            </paper-input>
            <paper-input id="uemail" type="email" label="email" value="{{putBody.email}}" error-message="Are you kidding me!!" required>
            </paper-input>

            <paper-dropdown-menu label="Role" value="{{putBody.role}}">
              <paper-listbox slot="dropdown-content" selected="1">
                <paper-item>Developer</paper-item>
                <paper-item>Product Owner</paper-item>
                <paper-item>Scrum master</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
          </paper-dialog-scrollable>

          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button affirmative autofocus on-tap="addTheUser">Add</paper-button>
          </div>
        </paper-dialog>

        <paper-dialog id="confirmDialog" backdrop autoclosedisabled>
          <h3>Dont say i did not warn you !!!</h3>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button affirmative autofocus on-tap="confirmRemoveUser">Remove</paper-button>
          </div>
        </paper-dialog>
  </template>

  <script>
    class RetroTeam extends Polymer.Element {
      static get is() { return 'retro-team'; }
      static get properties() {
        return {
          sortProperty: {
            type: String,
            notify: true
          },
          selectedRows: {
            type: Array,
            value: [],
            notify: true
          },
          data: {
            type: Array,
            value: [],
            notify: true
          },
          selectedIds: {
            type: Array,
            value: [],
            notify: true
          },
          putBody: {
            type: Object,
            value: function () {
              return {};
            }
          },
          postBody: {
            type: Object,
            value: function () {
              return {};
            }
          },
          deleteBody: {
            type: Object,
            value: function () {
              return {};
            }
          },
          addedUser: {
            type: Object
          },
          userError: {
            type: Object
          },
          rootPath: String
        };
      }


      addTheUser(event) {
        let isUnameValid = this.$.uname.validate();
        let isEmailValid = this.$.uemail.validate();
        if (isUnameValid && isEmailValid) {
          this.$.addUser.generateRequest();
          this.$.dialog.close();
        }
      }

      addSuccess() {
        this.$.addConfirm.open();
      }

      userAddError() {
        this.$.allfailed.open();
      }

      addNewMember() {
        this.set('putBody.name', null);
        this.set('putBody.email', null);
        this.$.uname.invalid = false;
        this.$.uemail.invalid = false;
        this.$.dialog.toggle();
      }

      _handleSelectionChanged(event) {
        if (this.selectedIds.indexOf(event.detail.data.id) != -1) {
          this.selectedIds.splice(this.selectedIds.indexOf(event.detail.data.id), 1);
        } else {
          this.selectedIds.push(event.detail.data.id);
        }
      }

      deleteSuccess() {
        this.selectedIds = [];
        this.$.getUser.generateRequest();
      }

      confirmRemoveUser() {
        if (this.selectedIds.length != 0) {
          this.deleteBody.ids = this.selectedIds;
          this.$.deleteUser.generateRequest();
          this.$.confirmDialog.close();
        }
      }

      deleteUsers() {
        if (this.selectedIds.length != 0) {
          this.$.confirmDialog.toggle();
        }
      }

      _handleSort(event) {
        console.log(this.data);
        console.log(event.detail.sort.property);
        console.log(event.detail.sort.direction);
        this.sortProperty = event.detail.sort.property + ',' + event.detail.sort.direction;
        this.postBody.sortKey = event.detail.sort.direction;
        this.$.sortUser.generateRequest();
      }
    }

    window.customElements.define(RetroTeam.is, RetroTeam);
  </script>
</dom-module>