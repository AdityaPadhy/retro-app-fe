<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<dom-module id="retro-postcard">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
        font-family: sans-serif;
      }

      .verticalLine {
        border-left: thin solid black;
      }

      app-toolbar {
        background: darkblue;
        color: white;
      }

      app-toolbar paper-icon-button {
        background: rgb(207, 101, 101);
        border-radius: 30px;
        padding: 2px;
        float: right;
      }

      paper-card {
        margin: 5px 5px;
        --paper-card: {
          max-width: 300px;
          box-sizing: border-box;
        }
        ;
      }

      paper-dialog {
        min-width: 50px;
        min-height: 50px;
        display: block;
        font-family: sans-serif;
        background: white;
        color: black;
        padding: 24px;
        box-shadow: rgba(0, 0, 0, 0.24) -2px 5px 12px 0px, rgba(0, 0, 0, 0.12) 0px 0px 12px 0px;
      }

      paper-dialog paper-dialog-scrollable {
        --paper-dialog-scrollable: {
          box-sizing: border-box;
          width: 400px;
          height: 300px;
        }
      }

      .submitBtn paper-button {
        background: blue;
        min-width: 150px;
        min-height: 50px;
        margin-top: 1em;
        color : white;
        font-family: 'Roboto', 'Noto', sans-serif;
        font-weight: bold;
        font-size: 20px;
        -webkit-font-smoothing: antialiased;
      }

      .card-content {
        max-width: 250px;
        height: 70px;
        overflow: auto;
      }
    </style>

    <iron-ajax id="getCards" auto url="http://localhost:8888/postcard/cards" handle-as="json" last-response="{{data}}"></iron-ajax>

    <iron-ajax id="deleteCard" method="DELETE" on-error="deleteFailed" last-error="{{deleteError}}" on-response="deleteSuccess"></iron-ajax>

    <iron-ajax id="addCard" method="PUT" body="{{addItem}}" url="http://localhost:8888/postcard/add" content-type="application/json"
      on-error="addFailed" on-response="addSuccess" last-error="{{addError}}"></iron-ajax>

    <iron-ajax id="updateCard" method="POST" body="{{updateItem}}" url="http://localhost:8888/postcard/update" content-type="application/json"
      on-error="updateFailed" on-response="updateSuccess" last-error="{{addError}}"></iron-ajax>

    <paper-dialog id="deleteFailedDialog">
      <p>There is an error while deleting the card</p>
      <div class="buttons">
        <paper-button dialog-confirm>close</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="addFailedDialog">
      <p>There is an error while adding the card</p>
      <div class="buttons">
        <paper-button dialog-confirm>close</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="updateFailedDialog">
      <p>There is an error while updating the card</p>
      <div class="buttons">
        <paper-button dialog-confirm>close</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="addDialog" backdrop autoclosedisabled>
      <h2>Add new item</h2>
      <paper-dialog-scrollable>
        <paper-input id="title" label="Title" value="{{addItem.header}}" validate="^[A-Za-z0-9]*$" error-message="Enter the title"
          required>
        </paper-input>
        <paper-textarea id="description" label="Description" value="{{addItem.description}}" validate="^[A-Za-z0-9]*$" error-message="Please enter the description"
          required>
        </paper-textarea>
      </paper-dialog-scrollable>

      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button affirmative autofocus on-tap="addPostcard">Add</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="updateDialog" backdrop autoclosedisabled>
      <h2>Update item</h2>
      <paper-dialog-scrollable>
        <paper-input id="updateTitle" label="Title" value="{{updateItem.header}}" validate="^[A-Za-z0-9]*$" error-message="Enter the title"
          required>
        </paper-input>
        <paper-textarea id="updateDescription" label="Description" value="{{updateItem.description}}" validate="^[A-Za-z0-9]*$" error-message="Please enter the description"
          required>
        </paper-textarea>
      </paper-dialog-scrollable>

      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button affirmative autofocus on-tap="updatePostCardItem">Update</paper-button>
      </div>
    </paper-dialog>

    <div class="layout horizontal">

      <div class="flex">
        <app-header-layout>
          <div>
            <app-toolbar>
              <div main-title>START</div>
              <paper-icon-button icon="add" on-tap="addStartItem"></paper-icon-button>
            </app-toolbar>
          </div>

          <div>
            <dom-repeat id="random" items="{{data}}" filter="isStart">
              <template>
                <paper-card>
                  <div class="card-content">{{item.description}}</div>
                  <div class="card-actions">
                    <paper-icon-button icon="delete" on-tap="deletePostcard"></paper-icon-button>
                    <paper-icon-button icon="create" on-tap="updatePostCard"></paper-icon-button>
                  </div>
                </paper-card>
              </template>
            </dom-repeat>
          </div>
        </app-header-layout>
      </div>

      <div class="flex verticalLine">
        <div>
          <app-toolbar>
            <div main-title>STOP</div>
            <paper-icon-button icon="add" on-tap="addStopItem"></paper-icon-button>
          </app-toolbar>
        </div>

        <div>
          <dom-repeat items="{{data}}" filter="isStop">
            <template>
              <paper-card>
                <div class="card-content">{{item.description}}</div>
                <div class="card-actions">
                  <paper-icon-button icon="delete" on-tap="deletePostcard"></paper-icon-button>
                  <paper-icon-button icon="create" on-tap="updatePostCard"></paper-icon-button>
                </div>
              </paper-card>
            </template>
          </dom-repeat>
        </div>
      </div>


      <div class="flex verticalLine">
        <div>
          <app-toolbar>
            <div main-title>CONTINUE</div>
            <paper-icon-button icon="add" on-tap="addContinueItem"></paper-icon-button>
          </app-toolbar>
        </div>

        <div>
          <dom-repeat items="{{data}}" filter="isContinue">
            <template>
              <paper-card>
                <div class="card-content">{{item.description}}</div>
                <div class="card-actions">
                  <paper-icon-button icon="delete" on-tap="deletePostcard"></paper-icon-button>
                  <paper-icon-button icon="create" on-tap="updatePostCard"></paper-icon-button>
                </div>
              </paper-card>
            </template>
          </dom-repeat>
        </div>
      </div>

    </div>

    <div class="submitBtn">
      <center>
        <paper-button raised class="green" on-tap="submitCards">Submit All Cards</paper-button>
      </center>
    </div>

  </template>

  <script>
    class RetroPostcard extends Polymer.Element {
      static get is() {
        return 'retro-postcard';
      }

      static get properties() {
        return {
          data: {
            type: Array,
            value: [],
            notify: true
          },
          deleteError: {
            type: Object
          },
          addError: {
            type: Object
          },
          addItem: {
            type: Object,
            value: function () {
              return {};
            }
          },
          updateItem: {
            type: Object,
            value: function () {
              return {};
            }
          }
        };
      }

      submitCards() {
        console.log("Submit all");
      }

      isStart(item) {
        return item.type.toUpperCase() == 'START';
      }

      isStop(item) {
        return item.type.toUpperCase() == 'STOP';
      }

      isContinue(item) {
        return item.type.toUpperCase() == 'CONTINUE';
      }

      deletePostcard(event) {
        this.$.deleteCard.set('url', 'http://localhost:8888/postcard/delete/' + event.model.__data.item.id);
        this.$.deleteCard.generateRequest();
      }

      updatePostCard(event) {
        this.updateItem = event.model.__data.item;
        this.$.updateDialog.toggle();
      }

      deleteFailed() {
        this.$.deleteFailedDialog.toggle();
      }

      deleteSuccess() {
        this.$.getCards.generateRequest();
      }

      addPostcard(event) {
        let isTitleValid = this.$.title.validate();
        let isDescValid = this.$.description.validate();
        if (isTitleValid && isDescValid) {
          this.$.addCard.generateRequest();
          this.$.addDialog.close();
        }
      }

      updatePostCardItem(event) {
        let isTitleValid = this.$.updateTitle.validate();
        let isDescValid = this.$.updateDescription.validate();
        if (isTitleValid && isDescValid) {
          this.$.updateCard.generateRequest();
          this.$.updateDialog.close();
        }
      }

      addStartItem() {
        this.addItem = {};
        this.$.title.invalid = false;
        this.$.description.invalid = false;
        this.addItem.type = "START";
        this.$.addDialog.toggle();
      }

      addContinueItem() {
        this.addItem = {};
        this.$.title.invalid = false;
        this.$.description.invalid = false;
        this.addItem.type = "CONTINUE";
        this.$.addDialog.toggle();
      }

      addStopItem() {
        this.addItem = {};
        this.$.title.invalid = false;
        this.$.description.invalid = false;
        this.addItem.type = "STOP";
        this.$.addDialog.toggle();
      }

      addFailed() {
        this.$.addCard.set('body', {});
        this.$.addFailedDialog.toggle();
      }

      updateFailed() {
        this.$.updateCard.set('body', {});
        this.$.updateFailedDialog.toggle();
      }

      updateSuccess() {
        this.$.getCards.generateRequest();
      }

      addSuccess() {
        this.$.getCards.generateRequest();
      }
    }

    window.customElements.define(RetroPostcard.is, RetroPostcard);
  </script>
</dom-module>